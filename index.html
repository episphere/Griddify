<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tissue Microarray De-Arraying Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">
    <link href="./style2.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <!-- Include Box CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn01.boxcdn.net/platform/elements/19.0.0/en-US/picker.css" />

</head>

<body class="bg-gray-100">
    <div class="body-container mx-auto px-4 lg:ma">

        <header class="px-1 py-1 shadow-sm relative">
            <div class="container mx-auto flex justify-between items-center">
                <a href="./" class="flex items-center hover:bg-inherit">
                    <img src="./icons/Logo.webp" alt="Your Logo" class="h-8 w-8 mr-2 rounded-full">
                    <h1 class="text-3xl font-light text-gray-800">Griddify</h1>
                </a>
                <!-- Mobile Menu Button -->
                <button id="menuBtn" class="z-20 md:hidden block text-gray-800 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7">
                        </path>
                    </svg>
                </button>
                <!-- Mobile Dropdown Menu -->
                <div id="navMenuMobile"
                    class="hidden absolute z-10 right-10 mt-1 w-24 bg-gray-100 shadow-md py-2 rounded-md transform translate-x-0 transition-transform duration-300 ease-out"
                    style="top: 30%">
                    <a href="./"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">Home</a>
                    <a href="https://github.com/episphere/TMA-De-arraying"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">GitHub</a>
                    <a href="https://github.com/episphere/TMA-De-arraying/issues"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">Issues</a>
                    <a href="#"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">Manuscript</a>
                    <button id="helpButtonMobile" class="actionButton px-4">?</button> <!-- Add this line -->

                </div>
                <!-- Desktop Navigation Menu -->
                <nav class="hidden md:flex items-center space-x-4">
                    <a href="./"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">Home</a>
                    <a href="https://github.com/episphere/TMA-De-arraying"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">GitHub</a>
                    <a href="https://github.com/episphere/TMA-De-arraying/issues"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">Issues</a>
                    <a href="#"
                        class="text-sm text-gray-800 hover:underline transition-colors duration-200 block px-4 py-2">Manuscript</a>
                    <button id="helpButton" class="actionButton px-4">?</button> <!-- Add this line -->

                </nav>
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const menuBtn = document.getElementById('menuBtn');
                    const navMenuMobile = document.getElementById('navMenuMobile');

                    menuBtn.addEventListener('click', () => {
                        navMenuMobile.classList.toggle('hidden');
                    });
                });
            </script>
        </header>
        <div id="app">

            <section id="upload" class="py-5 ">

                <div class="instructions-container space-y-4">
                    <button class="close-instructions text-right">✕</button>
                    <h2 class="text-xl font-semibold">Uploading an Image</h2>
                    <p>Begin by uploading a <span id="file-name">.svs</span> image. You can also work with <span id="file-name">.png</span> or <span id="file-name">.jpg</span> files, but virtual gridding is not 
                        fully supported with these file formats
                    </p>
                    <p>Once the image has been successfully uploaded, click the "Proceed"
                        button to continue to image segmentation.</p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">

                    <nav class="flex mb-5 border-b justify-center">
                        <button
                            class="active upload-option-tab px-6 py-2 text-gray-800 border-b-2 border-blue-500 hover:text-gray-800 hover:border-blue-500 focus:outline-none focus:text-gray-800 focus:border-blue-500"
                            data-target="direct-upload">Direct Upload</button>
                        <button
                            class="upload-option-tab px-6 py-2 text-gray-600 border-b-2 border-transparent hover:text-gray-800 hover:border-blue-500 focus:outline-none focus:text-gray-800 focus:border-blue-500"
                            data-target="url-upload">Image URL</button>
                        <button
                            class="upload-option-tab px-6 py-2 text-gray-600 border-b-2 border-transparent hover:text-gray-800 hover:border-blue-500 focus:outline-none focus:text-gray-800 focus:border-blue-500"
                            data-target="box-upload">Box Integration</button>
                    </nav>
                    <div class="preview-image">
                        <img src="./icons/Placeholder_view_vector.svg" alt="Uploaded Image"
                            class="mx-auto w-96 h-64 mb-6" id="previewImage">
                        <div id="loadingSpinner" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    <div id="imageLoadStatus" class="load-status neutral-message">
                        No image uploaded.
                    </div>



                    <div id="tab-contents" class="mb-20">
                        <div id="direct-upload" class="tab-content active">
                            <div id="drop-area">
                                <form class="my-form">
                                    <p>Drag and drop files here</p>
                                    <p>or</p>
                                    <label class="browse-button" for="fileInput">Browse Files</label>
                                    <input type="file" id="fileInput" accept="image/*,.svs" style="display: none;">
                                    <p class="small">Maximum file size is 100MB.</p>
                                </form>

                            </div>
                            <div id="file-info" class="hidden width-90-middle">
                                <img src="./icons/image-file-icon.svg" alt="File icon" id="file-icon" class="file-icon">
                                <div id="file-details">
                                    <span id="file-name">screenshot.png</span>
                                    <span id="file-size">(2MB)</span>
                                </div>
                                <button type="button" id="remove-file" class="remove-button">×</button>
                            </div>
                        </div>

                        <div id="url-upload" class="tab-content flex gap-6 hidden">

                            <input type="text" id="imageUrlInput"
                                class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                placeholder="Enter Image URL"
                                value="https://episphere.github.io/TMA-De-arraying/HD%20TMA%202%202011%20H&E%20stain.svs-[1499,1169,42287,37957]1x.png" />
                            <button id="loadImageUrlBtn" type="button" class="standard-button">Load Image</button>
                        </div>

                        <div id="box-upload" class="tab-content hidden">

                            <button id="boxLoginBtn"
                                class="btn-box-connect flex justify-center bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mx-auto">Connect
                                to Box</button>

                            <div id="boxFilesContainer" class="box-files-container w-full">
                                <!-- Dynamically loaded Box files will go here -->
                            </div>

                        </div>

                    </div>


                    <div class="mt-6 width-90-middle">
                        <label class="block text-sm font-semibold text-gray-700">Optional Metadata File:</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="metadataFile" class="file-input" accept=".csv,.json,.xlsx, .xls" onchange="displayFileInfo(this)">
                            <label for="metadataFile" class="file-upload-button">Choose files</label>
                            <button class="skip-button" id="useTemplate" onclick="">Use Template</button>
                        </div>
                        
                        <div id="metadata-file-info" class="hidden width-90-middle"
                            style="width: 100%; margin-top: 20px;">
                            <img src="./icons/image-file-icon.svg" alt="File icon" id="file-icon" class="file-icon">
                            <div id="metadata-file-details">
                                <span id="metadata-file-name"></span>
                                <span id="metadata-file-size"></span>
                            </div>
                            <button type="button" id="metadata-remove-file" class="remove-button">×</button>
                        </div>
                    </div>
                    <div id="metadataLoadStatus" class="load-status neutral-message">
                        No metadata uploaded.
                    </div>


                    <script>
                        function displayFileInfo(input) {
                            if (input.files && input.files[0]) {
                                var size = (input.files[0].size / 1024).toFixed(2); // size in KB
                                var name = input.files[0].name;
                                document.getElementById('metadata-file-name').textContent = name;
                                document.getElementById('metadata-file-size').textContent = '(' + size + ' KB)';
                                document.getElementById('metadata-file-info').classList.remove('hidden');
                            }
                        }


                    </script>

                </div>
                <div class="flex justify-end mt-6">
                    <button
                        class="btn-proceed px-6 py-2 bg-green-500 hover:bg-green-700 text-white font-bold rounded focus:outline-none shadow-lg">Proceed</button>
                </div>
            </section>

            <section id="segmentation" class="hidden py-12">
                <div class="instructions-container space-y-4">
                    <button class="close-instructions text-right">✕</button>
                    <h2 class="text-xl font-semibold">Completing Core Segmentation</h2>
                    <p>Begin by fine-tuning the segmentation parameters to ensure the algorithm
                        detects
                        most of the cores. Make any manual adjustments if needed to capture all
                        cores
                        accurately.</p>
                    <p>Once you're satisfied with the segmentation, click the "Proceed"
                        button. You can then proceed to the Gridding tab to continue.</p>
                </div>

                <div class="instructions-container mt-4 space-y-4">
                    <button class="close-instructions text-right">✕</button>
                    <h2 class="text-xl font-semibold">Interactive Core Editing</h2>
                    <p>To add a core, simply click on the desired location within the image.</p>
                    <p> If you wish to remove a core, hold the <kbd>Shift</kbd> key and click on the
                        core you want to remove.</p>
                </div>
                <div class="flex flex-wrap-mx-4">
                    <!-- Sidebar -->
                    <aside id="segmentation-sidebar"
                        class="bg-gray-50 rounded-lg shadow-lg p-1 transition-all duration-300 transform md:translate-x-0 sm:block collapsed">
                        <fieldset>

                            <div class="text-xl font-semibold mb-4 parameters-header">
                                <h2 class="title">Segmentation Parameters</h2>
                                <div class="window-controls">
                                    <button class="close-button" onclick="toggleSidebarSegmentation()">×</button>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <label for="maskAlphaSlider" class="text-sm font-medium text-gray-700 block">Mask
                                    Alpha: <span id="maskAlphaValue">0.3</span></label>
                                <input type="range" id="maskAlphaSlider" min="0" max="1" step="0.025" value="0.3"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">

                                <label for="thresholdSlider" class="text-sm font-medium text-gray-700 block">Threshold:
                                    <span id="thresholdValue">0.5</span></label>
                                <input type="range" id="thresholdSlider" min="0.01" max="0.99" step="0.0025" value="0.5"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">

                                <label for="minAreaInput" class="text-sm font-medium text-gray-700 block">Min
                                    Area:</label>
                                <input type="number" id="minAreaInput" value="1" step="1" min="1"
                                    class="w-full border-gray-300 rounded-md shadow-sm">

                                <label for="maxAreaInput" class="text-sm font-medium text-gray-700 block">Max
                                    Area:</label>
                                <input type="number" id="maxAreaInput" value="2000" step="1" min="1"
                                    class="w-full border-gray-300 rounded-md shadow-sm">

                                <label for="disTransformMultiplierInput"
                                    class="text-sm font-medium text-gray-700 block">Distance
                                    Transform
                                    Multiplier:</label>
                                <input type="number" id="disTransformMultiplierInput" value="0.65" step="0.025"
                                    min="0.1" max="1" class="w-full border-gray-300 rounded-md shadow-sm">
                            </div>

                            <button type="button" id="applySegmentation"
                                class="mt-4 w-full bg-blue-600 text-white rounded-lg py-2 font-medium hover:bg-blue-700 focus:outline-none focus:ring focus:ring-blue-300 transition duration-150 ease-in-out">
                                Apply
                            </button>
                        </fieldset>
                    </aside>
                    <!-- Sidebar Toggle Icon -->
                    <div id="segmentationSidebarIcon" class="parameterSidebar" onclick="toggleSidebarSegmentation()">
                        <!-- Menu Icon (three horizontal lines) -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </div>


                    <div id="ImageSegmentation" class="flex-grow sm:block sm:w-full">
                        <img id="originalImage" src="#" alt="Original Tissue" class="hidden">
                        <canvas id="segmentationResultsCanvas" alt="Processed Tissue" class="mx-auto w-4/5"></canvas>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button
                        class="btn-back px-6 py-2 bg-red-500 hover:bg-red-700 text-white font-bold rounded focus:outline-none focus:ring-4 focus:ring-red-300 shadow-lg">Back</button>
                    <button id="finalizeSegmentation"
                        class="btn-proceed px-6 py-2 bg-green-500 hover:bg-green-700 text-white font-bold rounded focus:outline-none focus:ring-4 focus:ring-green-300 shadow-lg">Proceed</button>
                </div>
            </section>
            <script>
                // Function to toggle the sidebar
                function toggleSidebarSegmentation() {
                    var sidebar = document.getElementById('segmentation-sidebar');
                    var segmentationSidebarIcon = document.getElementById('segmentationSidebarIcon');

                    sidebar.classList.toggle('collapsed');
                    segmentationSidebarIcon.classList.toggle('hidden');
                    console.log("Hidden")
                }
            </script>



            <section id="gridding" class="hidden">
                <div id="rawDataLoadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                </div>


                <div class="instructions-container mb-4">

                    <button class="close-instructions text-right">✕</button>

                    <h2 class="text-lg font-semibold">Gridding Instructions</h2>
                    <p>First, ensure that the image is rotated correctly. If not, adjust the image
                        rotation
                        parameter.</p>
                        
                    <p>To adjust the size of each core, select the core and resize it using the anchor points in the corner.</p>
                </div>
                <!-- Similar structure for Adding Cores Instructions -->
                <div class="instructions-container mb-4">
                    <button class="close-instructions text-right">✕</button>

                    <h2 class="text-lg font-semibold">Adding Cores</h2>
                    <p>To add a core, click on the Add Core button on the top left corner of the page. 
                        Then, drag the core at the location you would like it to be created on.</p>
                </div>

                <div class="flex flex-wrap lg:flex-nowrap">
                    <!-- Sidebar Toggle Icon -->
                    <div id="griddingSidebarIcon" class="parameterSidebar" onclick="toggleSidebarGridding()">
                        <!-- Menu Icon (three horizontal lines) -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </div>
                    <!-- Sidebar -->
                    <aside id="gridding-sidebar"
                        class="sm:w-full lg:w-1/5 bg-white p-2 rounded-lg shadow transition-all duration-300 collapsed">
                        <form id="hyperparameters-form" class="space-y-6 gridding-sidebar-content">
                            <div class="text-xl font-semibold mb-4 parameters-header">
                                <h2 class="title">Configure Parameters</h2>
                                <div class="window-controls">
                                    <button class="close-button" onclick="toggleSidebarGridding()">×</button>
                                </div>
                            </div>

                            <!-- Image Parameters Section -->
                            <fieldset class="p-4 bg-gray-50 rounded-lg">
                                <legend class="font-medium text-lg">Image Parameters</legend>
                                <div class=" flex-col space-y-4 mt-2">
                                    <label for="userRadius" class="block">
                                        Core Radius: <output id="radiusValue" for="userRadius">20</output>
                                    </label>
                                    <input type="range" id="userRadius" name="userRadius" min="1" max="100" value="20"
                                        class="w-full">
                                </div>
                            </fieldset>
                            <!-- Traveling Algorithm Section -->
                            <fieldset class="p-4 bg-gray-50 rounded-lg mt-4">
                                <legend class="font-medium text-lg">Traveling Algorithm Parameters</legend>
                                <div class=" flex-col space-y-4 mt-2">
                                    <label for="originAngle" title="Rotation of the image in degrees">
                                        Image Rotation: <output id="originAngleValue" for="originAngle">0</output>
                                    </label>
                                    <input type="range" id="originAngle" name="originAngle" min="-90" max="90" value="0"
                                        class="w-full">
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend>Display Parameters</legend>
                                <!-- Check box for whether adjacent cores should be connected by lines -->
                                <div class="checkbox-group">
                                    <input type="checkbox" id="connectCoresCheckbox" name="connectCores" checked>
                                    <label for="connectCoresCheckbox">Connect Cores</label>
                                </div>


                                <div class="checkbox-group">
                                    <input type="checkbox" id="flagMisalignmentCheckbox" name="flagMisalignmentCheckbox"
                                        checked>
                                    <label for="flagMisalignmentCheckbox">Flag Misaligned Cores</label>
                                </div>

                            </fieldset>

                            <!-- Advanced Settings Toggle -->
                            <div class="mt-4">
                                <label for="advanced-settings" class=" items-center cursor-pointer">
                                    <input type="checkbox" id="advanced-settings" class="toggle-checkbox">
                                    <span class="text-gray-700">Advanced Settings</span>
                                </label>
                            </div>
                            <!-- Advanced Settings Content -->
                            <!-- Wrap hidden fieldsets in a div -->
                            <div id="advanced-settings-content" class="hidden">
                                <!-- More Traveling Algorithm Parameters -->
                                <fieldset>

                                    <legend>Traveling Algorithm Parameters</legend>
                                    <label for="radiusMultiplier"
                                        title="Multiplier for the radius used in the traveling algorithm">Radius
                                        Multiplier</label>
                                    <input type="number" id="radiusMultiplier" name="radiusMultiplier" step="0.1"
                                        value="0.6">

                                    <label for="gridWidth"
                                        title="Width of one square in the grid used in the traveling algorithm">Grid
                                        Width</label>
                                    <input type="number" id="gridWidth" name="gridWidth" step="1" value="70">

                                    <label for="gamma"
                                        title="Distance after the the core with the greatest X value to stop the traveling algorithm">Stopping
                                        Distance</label>
                                    <input type="number" id="gamma" name="gamma" step="1" value="60">

                                    <label for="multiplier"
                                        title="Multiplier for the grid width calculation in the traveling algorithm">Multiplier
                                        for
                                        Grid Width</label>
                                    <input type="number" id="multiplier" name="multiplier" step="0.1" value="1.5">

                                    <label for="imageWidth"
                                        title="Width of the entire gird used in the traveling algorithm">Image
                                        Width</label>
                                    <input type="number" id="imageWidth" name="imageWidth" step="1" value="1024">

                                    <label for="searchAngle" title="Angle to search in the traveling algorithm">Search
                                        Angle</label>
                                    <input type="number" id="searchAngle" name="searchAngle" step="1" value="5">

                                </fieldset>

                                <!-- Edge Detection Section -->
                                <fieldset>
                                    <legend>Edge Detection Parameters</legend>

                                    <label for="thresholdMultiplier"
                                        title="Multiplier for the median absolute deviation to filter edges by length">Length
                                        Threshold
                                        Multiplier</label>
                                    <input type="number" id="thresholdMultiplier" name="thresholdMultiplier" step="0.1"
                                        value="1.2">

                                    <label for="thresholdAngle"
                                        title="The angle within which edges are considered valid">Threshold
                                        Angle</label>
                                    <input type="number" id="thresholdAngle" name="thresholdAngle" step="1" value="10">
                                </fieldset>

                                <!-- Image Rotation Section -->
                                <fieldset>
                                    <legend>Image Rotation Parameters</legend>

                                    <label for="minAngle" title="Minimum angle to test for image rotation">Minimum
                                        Angle</label>
                                    <input type="number" id="minAngle" name="minAngle" step="1" value="0">

                                    <label for="maxAngle" title="Maximum angle to test for image rotation">Maximum
                                        Angle</label>
                                    <input type="number" id="maxAngle" name="maxAngle" step="1" value="5">

                                    <label for="angleStepSize"
                                        title="Incremental step size for testing angles during image rotation">Angle
                                        Step
                                        Size</label>
                                    <input type="number" id="angleStepSize" name="angleStepSize" step="1" value="5">

                                    <label for="angleThreshold"
                                        title="Angle threshold used when filtering edges by angle for image rotation">Angle
                                        Threshold</label>
                                    <input type="number" id="angleThreshold" name="angleThreshold" step="1" value="20">
                                </fieldset>

                            </div>
                            <button type="button" id="apply-hyperparameters"
                                class="px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white font-bold rounded">Apply</button>

                        </form>

                    </aside>

                    <!-- Main Content -->
                    <main class="mx-auto w-full">
                        <!-- Main content goes here -->

                        <div class="flex" id="main-container">


                            <!-- Image Viewer or other main content -->
                            <div id="osdViewer" style="margin:auto">

                            </div>
                        </div>
                        <div class="edit-sidebar" id="editSidebar">
                            <div class="sidebar-header draggable-area">
                                <h2 class="title">Edit Core</h2>
                                <div class="window-controls">
                                    <button class="close-button" id="closeEditCoreButton">×</button>
                                </div>
                            </div>
                            <form id="editCoreForm" class="main-content">

                                <div class="checkbox-group">
                                    <input type="checkbox" id="editIsMarkerInput" name="editIsMarkerInput">
                                    <label for="editIsMarkerInput">Is a Marker</label>
                                </div>


                                <label for="editRowInput">Row:</label>
                                <input type="number" id="editRowInput" name="editRowInput" disabled>

                                <div class="checkbox-group">
                                    <input type="checkbox" id="editAutoUpdateRowsCheckbox"
                                        name="editAutoUpdateRowsCheckbox" checked>
                                    <label for="editAutoUpdateRowsCheckbox">Auto Assign Row</label>
                                </div>


                                <label for="editColumnInput">Column:</label>
                                <input type="number" id="editColumnInput" name="editColumnInput" disabled>


                                <div class="checkbox-group">
                                    <input type="checkbox" id="editAutoUpdateColumnsCheckbox"
                                        name="editAutoUpdateColumnsCheckbox" checked>
                                    <label for="editAutoUpdateColumnsCheckbox">Auto Assign Columns</label>
                                </div>

                                <label for="editXInput">X Position:</label>
                                <input type="number" id="editXInput" name="editXInput">

                                <label for="editYInput">Y Position:</label>
                                <input type="number" id="editYInput" name="editYInput">

                                <label for="editRadiusInput">Radius:</label>
                                <input type="number" id="editRadiusInput" name="editRadiusInput" step="0.1">

                                <label for="editAnnotationsInput">Annotations:</label>
                                <textarea type="text" id="editAnnotationsInput" name="editAnnotationsInput"></textarea>

                                <div class="radio-group">
                                    <input type="radio" id="editRealInput" name="coreType" value="real">
                                    <label for="editRealInput" class="radio-button">Normal</label>

                                    <input type="radio" id="editImaginaryInput" name="coreType" value="imaginary">
                                    <label for="editImaginaryInput" class="radio-button">Missing</label>
                                </div>


                                <div class="button-group">
                                    <button type="button" id="saveCoreEdits">Save</button>

                                    <button type="button" id="removeCoreButton">Remove</button>

                                </div>

                            </form>
                        </div>
                    </main>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button
                        class="btn-back px-4 py-2 bg-red-500 hover:bg-red-700 text-white font-bold rounded focus:outline-none shadow transition-colors duration-150">Back</button>
                    <button id="create-virtual-grid"
                        class="btn-proceed px-4 py-2 bg-green-500 hover:bg-green-700 text-white font-bold rounded focus:outline-none shadow transition-colors duration-150">Proceed</button>
                </div>
            </section>


            <script>
                // Function to toggle the sidebar
                function toggleSidebarGridding() {
                    var sidebar = document.getElementById('gridding-sidebar');
                    var griddingSidebarIcon = document.getElementById('griddingSidebarIcon');
                    sidebar.classList.toggle('collapsed');

                    griddingSidebarIcon.classList.toggle('hidden');
                }

            </script>


            <section id="virtual-grid" class="py-5 hidden">
                <script>
                    // Function to toggle the sidebar
                    function toggleSidebarVirtual() {
                        var sidebar = document.getElementById('virtual-grid-sidebar');
                        var virtualSidebarIcon = document.getElementById('virtualGridSidebarIcon');
                        sidebar.classList.toggle('collapsed');

                        virtualSidebarIcon.classList.tog                                    }

                        </script>
                
                <div class="instructions-container space-y-4">
                    <button class="close-instructions text-right">✕</button>
                    <h2 class="text-xl font-semibold">Utilizing the virtual grid</h2>
                    <p>To edit a core's metadata, select the core in the grid on the right hand side you'd like to edit to populate the metadata editing form.
                        Make sure you click the <span class="file-name">Update Metadata</span> button to save your changes.
                    </p>
                    <p>To export the full resolution of an individual core, double click that core. To export all the cores
                        click the <span class="file-name">Export Grid</span> button </p>
                </div>


                <div class="flex h-full">

                    <aside id="virtual-grid-sidebar"
                        class="w-1/3 bg-gray-50 p-1 rounded-lg shadow-lg mr-2 overflow-y-auto">
                        <div class="text-xl font-semibold mb-4 parameters-header">
                            <h2 class="title">Edit Metadata</h2>
                            <div class="window-controls">
                                <button class="close-button" style="display: none;" onclick="toggleSidebarVirtual()">×</button>
                            </div>
                        </div>
                        <form id="editMetadataForm" class="main-content" novalidate>
                            Please select a core to begin editing.
                        </form>

                        <h2 class="mt-5 mb-4 text-1xl font-extrabold leading-none tracking-tight text-gray-900 md:text-2xl lg:text-2xl dark:text-white"> Save Metadata</h2>
                        <div class="flex gap-2 mt-8 pb-5"> <!-- Added gap-2 for spacing between buttons -->
                            <button type="button"
                                class="mb-4 w-full inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white rounded-md focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none shadow transition duration-150 ease-in-out px-4 py-2 text-sm"
                                id="saveResultsAsJson">Save JSON</button>
                            <button type="button"
                                class="mb-4 w-full inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white rounded-md focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 focus:outline-none shadow transition duration-150 ease-in-out px-4 py-2 text-sm"
                                id="saveResultsAsCsv">Save CSV</button>
                        </div>
                        <fieldset style="display: none;">

                            <label for="horizontalSpacing">Horizontal Spacing:</label>
                            <input type="range" id="horizontalSpacing" name="horizontalSpacing" min="1" max="200"
                                value="100">
                            <output id="horizontalSpacingValue" for="horizontalSpacing">50</output>

                            <label for="verticalSpacing">Vertical Spacing:</label>
                            <input type="range" id="verticalSpacing" name="verticalSpacing" min="1" max="200"
                                value="100">
                            <output id="verticalSpacingValue" for="verticalSpacing">50</output>

                            <label for="startingX">Starting X:</label>
                            <input type="range" id="startingX" name="startingX" min="0" max="200" value="0">
                            <output id="startingXValue" for="startingX">0</output>

                            <label for="startingY">Starting Y:</label>
                            <input type="range" id="startingY" name="startingY" min="0" max="200" value="0">
                            <output id="startingYValue" for="startingY">0</output>

                            <button type="button" id="applyVirtualGridSettings"
                                class="flex-1 text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition duration-150 ease-in-out">Apply</button>
                        </fieldset>

                    </aside>

                    <!-- Virtual Grid Display and Interaction -->
                    <main class="flex-1 w-full mx-auto">
                        <div id="VirtualGrid" class="tabcontent">

                            <div class="flex">
                                <div id="virtualGridSidebarIcon" class="parameterSidebar hidden"
                                    onclick="toggleSidebarVirtual()">
                                    <!-- Menu Icon (three horizontal lines) -->
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </div>

                                <canvas id="virtualGridCanvas" width="1024" height="1024" style="border:none;"
                                    class="w-full"></canvas>
                                <!-- Put other virtual grid related content here -->

                                <div id="VirtualGridSVSContainer"></div>
                            </div>

                        </div>


                    </main>

                    <!-- Progress Overlay -->
                    <div id="progressOverlay">
                        <div class="progress-dialog">
                            <h2 class="progress-title">Export Progress</h2>
                            <div id="progressBarContainer">
                                <div id="progressBar"></div>
                            </div>
                            <p id="progressText">Initializing...</p>
                        </div>
                    </div>



                </div>

                <div class="flex justify-between mt-6">
                    <button
                        class="btn-back px-4 py-2 bg-red-500 hover:bg-red-700 text-white font-bold rounded focus:outline-none shadow-lg">
                        Back
                    </button>
                    <button id="downloadAllCoresButton"
                        class="px-6 py-2 bg-blue-500 hover:bg-blue-700 text-white font-bold rounded focus:outline-none shadow-lg">Export
                        Grid</button>
                </div>
            </section>

        </div>





        <!-- Carousel controls for the sections -->
        <div class="carousel-controls flex justify-center space-x-1 md:space-x-3 p-4 mb-10">
            <button id="imageUploadTabButton"
                class="carousel-control active w-3 h-3 md:w-4 md:h-4 rounded-full bg-gray-300 hover:bg-gray-400 focus:outline-none transition duration-150 ease-in-out"
                data-step="1"></button>
            <button id="imageSegmentationTabButton"
                class="carousel-control w-3 h-3 md:w-4 md:h-4 rounded-full bg-gray-300 hover:bg-gray-400 focus:outline-none transition duration-150 ease-in-out"
                data-step="2" disabled></button>
            <button id="rawDataTabButton"
                class="carousel-control w-3 h-3 md:w-4 md:h-4 rounded-full bg-gray-300 hover:bg-gray-400 focus:outline-none transition duration-150 ease-in-out"
                data-step="3" disabled></button>
            <button id="virtualGridTabButton"
                class="carousel-control w-3 h-3 md:w-4 md:h-4 rounded-full bg-gray-300 hover:bg-gray-400 focus:outline-none transition duration-150 ease-in-out"
                data-step="4" disabled></button>
            <!-- ... Add more buttons if you have more steps -->
        </div>


        <footer class="py-5">
            <p class="text-center text-sm text-gray-500">© 2024 Tissue Microarray De-Arraying Tool</p>
        </footer>
    </div>

    </div>
    <script src="app.js"></script>

    <!-- MAIN.JS -->
    <script type="module" src="main2.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/gh/openseadragon/svg-overlay/openseadragon-svg-overlay.js"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/episphere/GeoTIFFTileSource-JPEG2k@ed333822e17a52dbaf151312ec29c29b5b1d4da5/GeoTIFFTileSource.js"
        type="module" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.9.0-release.2/dist/opencv.min.js"></script>

    <!-- JSON Editor -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.5.6/jsoneditor.min.css" rel="stylesheet"
        type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.5.6/jsoneditor.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


    <!-- Box Content Picker Script -->
    <script src="https://cdn01.boxcdn.net/platform/elements/19.0.0/en-US/picker.js"></script>
</body>

</html>